<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIDENT V9.0 - SNIPER (Stable UI + Auto AI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    body { background:#000000; color:#e4e4e7; font-family:'JetBrains Mono', monospace; overflow-x:hidden; }
    
    /* Á©©ÂÆö UI (ÁÑ°ÈñÉÁàç) */
    .panel { background:#09090b; border-bottom:1px solid #27272a; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; padding: 12px; }
    
    /* Âç°ÁâáË®≠Ë®à */
    .card { background:#121214; border:1px solid #27272a; border-radius:8px; padding:12px; position:relative; transition: background 0.3s; }
    .card.active-long { border-color: #059669; background: #062c1b; }
    .card.active-short { border-color: #dc2626; background: #2f0e0e; }
    
    /* Êï∏ÂÄºÈ°èËâ≤ */
    .t-up { color: #34d399; } .t-down { color: #f87171; } .t-neu { color: #71717a; }
    
    /* ÁãôÊìäÊâãÈù¢Êùø (Top Signal) */
    #sniperPanel { 
        background: linear-gradient(180deg, #0f1f15 0%, #000000 100%); 
        border-bottom: 2px solid #059669; 
        min-height: 140px; 
        display: none; /* È†êË®≠Èö±ËóèÔºåÊúâË®äËôüÊâçÈñã */
        padding: 20px;
        animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ÈÄ≤Â∫¶Ê¢ùËàáÊ®ôÁ±§ */
    .loading-bar { height:2px; background:#27272a; width:100%; position:fixed; top:0; z-index:99; }
    .bar-fill { height:100%; background:#10b981; width:0%; transition: width 0.2s; }
    .tag { font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
    .tag-l { background:#064e3b; color:#34d399; border:1px solid #059669; }
    .tag-s { background:#450a0a; color:#f87171; border:1px solid #dc2626; }

    /* ÊåâÈàï */
    .btn { background:#27272a; border:1px solid #3f3f46; color:white; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer; }
    .btn:hover { background:#3f3f46; }
    .btn-act { background:#059669; border-color:#10b981; }

    /* Êï∏ÊìöÊ†º */
    .stat-row { display:flex; justify-content:space-between; font-size:11px; margin-top:4px; color:#a1a1aa; }
    .stat-val { font-weight:bold; color:#e4e4e7; }
  </style>
</head>
<body>

<div class="loading-bar"><div id="progBar" class="bar-fill"></div></div>

<div id="sniperPanel">
    <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-6 items-center">
        <div class="flex-1">
            <div class="text-xs text-green-400 font-bold tracking-widest mb-1">üî• AI SNIPER SIGNAL DETECTED</div>
            <div class="text-4xl font-black text-white flex items-end gap-3">
                <span id="aiSym">BTCUSDT</span>
                <span id="aiSide" class="tag tag-l text-lg align-middle">LONG</span>
            </div>
            <div class="text-sm text-gray-400 mt-2" id="aiReason">Analyzing market structure...</div>
        </div>
        <div class="flex-1 w-full bg-black/40 p-4 rounded border border-gray-800 grid grid-cols-3 gap-4 text-center">
            <div><div class="text-gray-500 text-xs">ENTRY</div><div id="aiEntry" class="text-white font-mono text-lg">-</div></div>
            <div><div class="text-gray-500 text-xs">TARGET</div><div id="aiTp" class="text-green-400 font-mono text-lg">-</div></div>
            <div><div class="text-gray-500 text-xs">STOP</div><div id="aiSl" class="text-red-400 font-mono text-lg">-</div></div>
        </div>
        <div class="text-right">
             <div class="text-xs text-gray-500">CONFIDENCE</div>
             <div id="aiConf" class="text-3xl font-bold text-green-500">0%</div>
        </div>
    </div>
</div>

<div class="panel p-3 flex justify-between items-center sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
    <div class="flex items-center gap-4">
        <div class="font-black italic text-lg text-white">TRIDENT <span class="text-emerald-500">V9</span></div>
        <div class="text-[10px] text-gray-500 flex gap-3">
            <span>SOCKET: <b id="wsState" class="text-yellow-500">CONNECTING</b></span>
            <span>UNIVERSE: <b id="uCount">0</b></span>
        </div>
    </div>
    <div class="flex gap-2">
        <input type="password" id="apiKey" placeholder="GROQ KEY" class="bg-black border border-gray-700 text-white text-xs p-1 rounded w-24">
        <button id="btnAuto" class="btn" onclick="toggleAuto()">AI AUTO: OFF</button>
    </div>
</div>

<div id="gridBox" class="grid-container">
    </div>

<script>
/* =========================================================================
   TRIDENT V9.0 - SNIPER CORE
   Key Tech:
   1. Virtual DOM Patching: getElementById() update instead of innerHTML rewrite.
   2. Score-Based AI Trigger: Only analyzes the highest potential coin.
   3. Backfill & Instant OI: No waiting for data.
   ========================================================================= */

const CONFIG = {
    UNIVERSE: 50,      // Âè™Áõ£ÊéßÂâç 50 Â§ßÊàê‰∫§Èáè (Â∞àÊ≥®ÊµÅÂãïÊÄß)
    AI_INTERVAL: 15000,// AI ÊØè 15 ÁßíÊéÉÊèè‰∏ÄÊ¨°
    VOL_THRESH: 1.5,   // Z-Score ÈñÄÊ™ª
    REFRESH_UI: 500    // UI Êõ¥Êñ∞È†ªÁéá (ms) - ÈõñÁÑ∂Âø´Ôºå‰ΩÜÂõ†ÁÇ∫ÊòØÂÆöÈªûÊõ¥Êñ∞Ôºå‰∏çÊúÉÈñÉ
};

// State
let symbols = {}; // { "BTCUSDT": { p:0, volZ:0, ... } }
let sortedSyms = [];
let isAuto = false;
let isAiBusy = false;
let GROQ_KEY = localStorage.getItem("V9_KEY") || "";
let wsPool = [];

// Init
const $ = id => document.getElementById(id);
const fmt = (n, d=2) => Number(n).toFixed(d);
const cls = (n) => n > 0 ? "t-up" : (n < 0 ? "t-down" : "t-neu");

async function init() {
    $("apiKey").value = GROQ_KEY;
    
    // 1. Fetch Universe
    const res = await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr");
    const data = await res.json();
    const top50 = data
        .filter(t => t.symbol.endsWith("USDT") && parseFloat(t.quoteVolume) > 50000000)
        .sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
        .slice(0, CONFIG.UNIVERSE);

    $("uCount").innerText = top50.length;

    // 2. Initialize State Objects (Á©∫ÊÆº)
    top50.forEach(t => {
        symbols[t.symbol] = {
            s: t.symbol, 
            p: parseFloat(t.lastPrice),
            volZ: 0, 
            deltaZ: 0,
            fund: 0,
            oi: 0,
            score: 0 // Ê©üÊúÉÂàÜÊï∏
        };
        createCard(t.symbol); // È†êÂÖàÂª∫Á´ã DOM ÂÖÉÁ¥†
    });

    // 3. Batch Backfill (Ë£úÊï∏Êìö)
    backfillData(top50.map(t=>t.symbol));

    // 4. Start Websocket
    startSocket(top50.map(t=>t.symbol));

    // 5. Loops
    setInterval(updateUI, CONFIG.REFRESH_UI); // ‰ªãÈù¢Êõ¥Êñ∞
    setInterval(aiScanner, CONFIG.AI_INTERVAL); // AI ÊéÉÊèè
}

// --- CORE: DOM CREATION (Âè™Âü∑Ë°å‰∏ÄÊ¨°) ---
function createCard(s) {
    const div = document.createElement("div");
    div.id = `card-${s}`;
    div.className = "card";
    div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-sm text-white">${s}</span>
            <span id="p-${s}" class="font-mono text-xs text-gray-400">---</span>
        </div>
        <div class="stat-row"><span>Vol Z</span><span id="v-${s}" class="stat-val">0.00</span></div>
        <div class="stat-row"><span>CVD Z</span><span id="d-${s}" class="stat-val">0.00</span></div>
        <div class="stat-row"><span>Fund%</span><span id="f-${s}" class="stat-val">0.0000</span></div>
        <div class="stat-row"><span>Score</span><span id="sc-${s}" class="stat-val text-yellow-500">0</span></div>
    `;
    $("gridBox").appendChild(div);
}

// --- CORE: DATA BACKFILL (Ë£úÈΩäÊ≠∑Âè≤) ---
async function backfillData(syms) {
    $("progBar").style.width = "30%";
    
    // 1. Funding (Global)
    try {
        const fRes = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex");
        const fData = await fRes.json();
        fData.forEach(x => {
            if(symbols[x.symbol]) symbols[x.symbol].fund = parseFloat(x.lastFundingRate)*100;
        });
    } catch(e){}

    // 2. Klines for Vol/CVD (Batching to avoid spam)
    let done = 0;
    const batchSize = 10;
    for(let i=0; i<syms.length; i+=batchSize) {
        const batch = syms.slice(i, i+batchSize);
        await Promise.all(batch.map(async (s) => {
            try {
                const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=15m&limit=50`).then(r=>r.json());
                // Calc Vol Z
                const vols = k.map(x=>parseFloat(x[5]));
                const mean = vols.reduce((a,b)=>a+b,0)/vols.length;
                const std = Math.sqrt(vols.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0)/vols.length);
                const lastVol = vols[vols.length-1];
                symbols[s].volZ = (lastVol - mean) / (std || 1);
                
                // Calc Est. CVD Z (Taker Buy Base Vol is index 9)
                const buys = k.map(x=>parseFloat(x[9]));
                const deltas = k.map((x, idx) => buys[idx] - (vols[idx]-buys[idx])); // Buy - Sell
                const dMean = deltas.reduce((a,b)=>a+b,0)/deltas.length;
                const dStd = Math.sqrt(deltas.map(x=>Math.pow(x-dMean,2)).reduce((a,b)=>a+b,0)/deltas.length);
                symbols[s].deltaZ = (deltas[deltas.length-1] - dMean) / (dStd || 1);
            } catch(e){}
        }));
        done += batch.length;
        $("progBar").style.width = `${30 + (done/syms.length)*70}%`;
    }
    setTimeout(()=>$("progBar").style.width="0%", 500);
}

// --- CORE: SOCKET (Âç≥ÊôÇÊï∏Êìö) ---
function startSocket(syms) {
    const streams = syms.map(s => `${s.toLowerCase()}@aggTrade`).join('/');
    const ws = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
    ws.onopen = () => { $("wsState").innerText = "LIVE"; $("wsState").className = "text-green-500"; };
    ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if(!msg.data) return;
        const t = msg.data;
        const s = symbols[t.s];
        if(s) {
            s.p = parseFloat(t.p);
            // Á∞°ÂñÆÁöÑÂØ¶ÊôÇÂãïÈáèÊ®°Êì¨
            const isBuy = !t.m;
            s.deltaZ += (isBuy ? 0.005 : -0.005);
            // Decay
            s.deltaZ *= 0.999; 
        }
    };
}

// --- CORE: UI UPDATE (NO FLICKER) ---
function updateUI() {
    // 1. Calculate Scores & Sort
    sortedSyms = Object.values(symbols).sort((a,b) => {
        // Score Logic: Vol + Abs(Delta) + Funding Penalty
        const scoreA = Math.abs(a.volZ) + Math.abs(a.deltaZ) - (Math.abs(a.fund)*10);
        const scoreB = Math.abs(b.volZ) + Math.abs(b.deltaZ) - (Math.abs(b.fund)*10);
        a.score = scoreA; b.score = scoreB;
        return scoreB - scoreA;
    });

    // 2. Patch DOM
    sortedSyms.forEach(s => {
        const el = $(`card-${s.s}`);
        if(el) {
            // Update Text Nodes Directly
            $(`p-${s.s}`).innerText = s.p;
            
            const vEl = $(`v-${s.s}`); vEl.innerText = fmt(s.volZ); vEl.className = `stat-val ${cls(s.volZ)}`;
            const dEl = $(`d-${s.s}`); dEl.innerText = fmt(s.deltaZ); dEl.className = `stat-val ${cls(s.deltaZ)}`;
            const fEl = $(`f-${s.s}`); fEl.innerText = fmt(s.fund, 4) + "%"; 
            const scEl = $(`sc-${s.s}`); scEl.innerText = fmt(s.score, 1);

            // Reorder visually using 'order' style (Flexbox/Grid hack) or just let them stay
            // ÁÇ∫Ê±ÇÁ©©ÂÆöÔºåÈÄôË£°‰∏çÈ†ªÁπÅÊîπËÆä DOM È†ÜÂ∫èÔºåÂè™È´ò‰∫ÆÂâçÂπæÂêç
            if(s.score > 3) el.style.borderColor = "#f59e0b"; // Gold border for high score
            else el.style.borderColor = "#27272a";
        }
    });
}

// --- CORE: AI SNIPER (Ëá™ÂãïÁãôÊìä) ---
async function aiScanner() {
    if(!isAuto || isAiBusy || sortedSyms.length === 0) return;
    
    // Pick Top 1 Candidate
    const target = sortedSyms[0];
    if(target.score < 2.0) return; // ÂàÜÊï∏Â§™‰Ωé‰∏çÁúã

    isAiBusy = true;
    $("btnAuto").innerText = `SCANNING: ${target.s}...`;

    try {
        const prompt = `
        ACT AS A CRYPTO SNIPER. ANALYZE: ${target.s}
        Price: ${target.p}
        Vol Z-Score: ${target.volZ} (High vol is good)
        Delta Z-Score: ${target.deltaZ} (Positive=Buy Pressure)
        Funding: ${target.fund}%
        
        DECISION RULES:
        1. IF Vol > 2 AND Delta > 1 -> LONG
        2. IF Vol > 2 AND Delta < -1 -> SHORT
        3. ELSE -> WAIT

        OUTPUT JSON ONLY:
        { "action": "LONG"|"SHORT"|"WAIT", "entry": price, "tp": price, "sl": price, "conf": 0-100, "reason": "short text" }
        `;

        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile", // Fast & Good
                messages: [{role: "user", content: prompt}],
                temperature: 0.1
            })
        });

        const json = await res.json();
        const content = json.choices[0].message.content.replace(/<think>.*<\/think>/s, "");
        const plan = JSON.parse(content.match(/\{.*\}/s)[0]);

        if(plan.action !== "WAIT" && plan.conf > 75) {
            showSniperPanel(target.s, plan);
        }

    } catch(e) { console.error(e); }
    
    isAiBusy = false;
    $("btnAuto").innerText = "AI AUTO: ON";
}

function showSniperPanel(sym, plan) {
    const p = $("sniperPanel");
    p.style.display = "block";
    
    $("aiSym").innerText = sym;
    $("aiSide").innerText = plan.action;
    $("aiSide").className = plan.action === "LONG" ? "tag tag-l text-lg align-middle" : "tag tag-s text-lg align-middle";
    
    $("aiEntry").innerText = plan.entry;
    $("aiTp").innerText = plan.tp;
    $("aiSl").innerText = plan.sl;
    $("aiConf").innerText = plan.conf + "%";
    $("aiReason").innerText = plan.reason;
    
    // Play sound or flash effect here if needed
}

function toggleAuto() {
    isAuto = !isAuto;
    GROQ_KEY = $("apiKey").value;
    localStorage.setItem("V9_KEY", GROQ_KEY);
    $("btnAuto").classList.toggle("btn-act", isAuto);
    $("btnAuto").innerText = isAuto ? "AI AUTO: ON" : "AI AUTO: OFF";
}

window.onload = init;
</script>
</body>
</html>
