<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIDENT V7.7 - DeepSeek (Stable Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    body { background:#050505; color:#d4d4d8; font-family:'JetBrains Mono', monospace; overflow-x:hidden; }
    .panel { background:#0f0f11; border:1px solid #1f1f23; }
    .muted { color:#71717a; }
    .badge { border:1px solid #27272a; background:#0b0b0d; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
    .ok { color:#22c55e; } .warn { color:#f59e0b; } .bad { color:#ef4444; } .violet { color:#a78bfa; }
    .card { background:#0f0f11; border:1px solid #1f1f23; border-radius:14px; overflow:hidden; position:relative; }
    .card-top1 { border:2px solid #22c55e !important; box-shadow:0 0 15px rgba(34,197,94,0.15); }
    .btn { border:1px solid #27272a; background:#0b0b0d; border-radius:6px; padding:8px 16px; font-weight:700; font-size:13px; transition:0.2s; cursor:pointer; }
    .btn:hover { background:#27272a; color:white; }
    .btn-green { border-color:#16a34a; color:#86efac; background:rgba(22,163,74,0.2); }
    .btn-green:hover { background:rgba(22,163,74,0.4); }
    .hb { width:8px; height:8px; background:#333; border-radius:50%; display:inline-block; margin-right:6px; }
    .hb-on { background:#22c55e; box-shadow:0 0 6px #22c55e; }
    select { background:#09090b; border:1px solid #27272a; color:#e4e4e7; padding:8px; border-radius:6px; font-size:12px; outline:none; cursor:pointer; }
    input { background:#09090b; border:1px solid #27272a; color:#e4e4e7; padding:8px; border-radius:6px; font-size:12px; outline:none; width: 200px; }
    /* Scrollbar */
    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:#000; }
    ::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
  </style>
</head>
<body class="p-4 text-sm">

<div class="panel p-4 rounded-xl mb-4 flex flex-col gap-4 shadow-lg">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold tracking-tight text-white flex items-center">
      <span id="hb" class="hb"></span>TRIDENT <span class="text-green-500 text-sm ml-2">V7.7 (Stable)</span>
    </h1>
    <div class="flex gap-2">
      <span class="badge">Universe: <b id="univCount" class="text-white">0</b></span>
      <span class="badge">Socket: <b id="binStatus" class="muted">init...</b></span>
      <span class="badge">AI: <b id="aiStatus" class="muted">Idle</b></span>
    </div>
  </div>

  <div class="flex flex-wrap items-center gap-3 border-t border-gray-800 pt-3">
    <div class="flex flex-col gap-1">
        <label class="text-[10px] text-gray-500 font-bold">MODEL (Ê®°Âûã)</label>
        <select id="modelSelect" class="w-64">
            <option value="deepseek-r1-distill-llama-70b" selected>DeepSeek R1 (OpenAI-Level)</option>
            <option value="llama-3.3-70b-versatile">Llama 3.3 (Open GPT-4)</option>
        </select>
    </div>
    
    <div class="flex flex-col gap-1">
        <label class="text-[10px] text-gray-500 font-bold">GROQ API KEY</label>
        <div class="flex gap-1">
            <input type="password" id="groqKeyInput" placeholder="gsk_xxxxxxxx..." />
            <button id="btnSaveKey" class="btn px-3 py-1 text-xs">Â≠òÊ™î</button>
        </div>
    </div>

    <div class="flex items-end gap-2 ml-auto">
        <button id="btnRunAI" class="btn btn-green h-[38px] flex items-center gap-2">
           üöÄ ÂïüÂãï AI ÂàÜÊûê
        </button>
        <button id="btnToggleAI" class="btn border-gray-600 h-[38px]">
          <span id="autoLbl">Auto: OFF</span>
        </button>
    </div>
  </div>
</div>

<div id="errorBox" class="hidden mb-4 p-3 bg-red-900/20 border border-red-500/50 rounded-lg text-red-300 text-xs font-mono whitespace-pre-wrap"></div>

<div id="card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

<div class="mt-6 border-t border-gray-800 pt-2">
  <div class="flex justify-between items-center mb-1">
    <span class="text-xs font-bold text-gray-500">SYSTEM LOGS</span>
    <button onclick="document.getElementById('logs').innerHTML=''" class="text-[10px] text-gray-600 hover:text-white">CLEAR</button>
  </div>
  <div id="logs" class="h-48 overflow-y-auto font-mono text-[11px] opacity-90 space-y-1 bg-[#0a0a0a] p-2 rounded border border-gray-800"></div>
</div>

<script>
/* =========================================================================
   TRIDENT V7.7 - STABLE FIX
   1. Added try/catch to all async functions
   2. Fixed AI crash when candidates are empty
   3. Added explicit parsing error handling
   ========================================================================= */

const CONFIG = {
  MIN_VOL: 0, 
  UNIVERSE_REFRESH_MS: 10 * 60 * 1000, 
  CANDIDATE_REFRESH_MS: 1000, 
  ROLL_5M_MS: 5 * 60 * 1000,
  MAX_TRADES_STORE: 1000, 
  BTC_SYMBOL: "BTCUSDT"
};

const IGNORED = [
  "USDCUSDT","BUSDUSDT","TUSDUSDT","USDPUSDT","EURUSDT","FDUSDUSDT",
  "BTCUPUSDT","BTCDOWNUSDT","ETHUPUSDT","ETHDOWNUSDT","BNBUPUSDT","BNBDOWNUSDT",
  "BTCDOMUSDT", "1000LUNCUSDT", "USTCUSDT"
];

// STATE
let universe = [];
let symState = {}; 
let socketPool = [];
let candidatesTopN = [];
let GROQ_KEY = localStorage.getItem("TRIDENT_GROQ_KEY") || "";
let AUTO_AI = false;
let AI_MODEL = "deepseek-r1-distill-llama-70b"; 

// UTILS
const $ = (id) => document.getElementById(id);
const log = (msg, type="info") => {
    const l = $("logs");
    if(!l) return;
    const div = document.createElement("div");
    let color = "text-gray-400";
    if(type==="error") color = "text-red-400 font-bold";
    if(type==="success") color = "text-green-400";
    if(type==="warn") color = "text-yellow-400";
    div.innerHTML = `<span class="text-gray-600 mr-2">[${new Date().toLocaleTimeString()}]</span><span class="${color}">${msg}</span>`;
    l.prepend(div);
};
const setStatus = (id, txt, cls) => {
  const el = $(id); if(el) { el.textContent = txt; el.className = cls; }
};
const showError = (msg) => {
    const box = $("errorBox");
    if(box) {
        box.textContent = "‚ö†Ô∏è " + msg;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), 8000);
    }
};

async function fetchJSON(url) {
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch(e) { return null; }
}

// 1. DATA INGESTION
function initCombinedStream(symbols) {
  try {
      socketPool.forEach(s => s.close());
      socketPool = [];
      setStatus("binStatus", "ÈáçÂª∫ÈÄ£Á∑ö...", "warn");
      
      const chunkSize = 50;
      for (let i = 0; i < symbols.length; i += chunkSize) {
        const chunk = symbols.slice(i, i + chunkSize);
        const streamName = chunk.map(s => `${s.toLowerCase()}@aggTrade`).join('/');
        const url = `wss://fstream.binance.com/stream?streams=${streamName}`;
        
        const ws = new WebSocket(url);
        ws.onopen = () => { if(i===0) setStatus("binStatus", "Áõ£Êéß‰∏≠ (Live)", "ok"); };
        ws.onmessage = (ev) => {
            try {
                const packet = JSON.parse(ev.data);
                if (packet.data) processAggTrade(packet.data);
            } catch(e) { console.error("WS Parse Error", e); }
        };
        ws.onerror = () => setStatus("binStatus", "ÈÄ£Á∑öÈåØË™§", "bad");
        socketPool.push(ws);
      }
      $("hb").classList.add("hb-on");
  } catch(e) { log("Socket Init Error: " + e.message, "error"); }
}

function processAggTrade(d) {
    const sym = d.s;
    if (!symState[sym]) return;
    const s = symState[sym];
    const ts = d.T;
    const price = parseFloat(d.p);
    const qty = parseFloat(d.q);
    const notional = price * qty;
    const isBuy = !d.m; 
    
    s.price = price;
    s.trades.push({ ts, notional, deltaNotional: isBuy ? notional : -notional });

    if (s.trades.length % 50 === 0) {
        const cutoff = Date.now() - CONFIG.ROLL_5M_MS;
        while(s.trades.length > 0 && s.trades[0].ts < cutoff) s.trades.shift();
        if(s.trades.length > CONFIG.MAX_TRADES_STORE) s.trades.splice(0, s.trades.length - CONFIG.MAX_TRADES_STORE);
    }
    
    const stats = calcStats(s.trades, ts);
    s.volZ = stats.volZ;
    s.deltaZ = stats.deltaZ;
}

// 2. MATH
function calcStats(trades, now) {
  if (trades.length < 10) return { volZ:0, deltaZ:0 };
  const cutoff = now - CONFIG.ROLL_5M_MS;
  let sum=0, sqSum=0, dSum=0, dSqSum=0, n=0;
  for (let i = trades.length - 1; i >= 0; i--) {
    const t = trades[i];
    if (t.ts < cutoff) break;
    sum += t.notional; sqSum += t.notional**2;
    dSum += t.deltaNotional; dSqSum += t.deltaNotional**2;
    n++;
  }
  if (n < 5) return { volZ:0, deltaZ:0 };
  const mean = sum/n;
  const std = Math.sqrt((sqSum/n) - mean*mean);
  const dMean = dSum/n;
  const dStd = Math.sqrt((dSqSum/n) - dMean*dMean);
  const last = trades[trades.length-1];
  return {
      volZ: std > 0 ? (last.notional - mean)/std : 0,
      deltaZ: dStd > 0 ? (last.deltaNotional - dMean)/dStd : 0
  };
}

async function ensureKlinesAndOI(sym) {
    if(!symState[sym]) return;
    try {
        // Safe fetch, ignore errors
        const kRes = await fetchJSON(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=5m&limit=30`);
        if(kRes) symState[sym].klines = kRes;
    } catch(e) {}
}

// 3. AI & LOGIC
async function refreshUniverse() {
    log("Êõ¥Êñ∞Â∏ÇÂ†¥Ê∏ÖÂñÆ...", "warn");
    const res = await fetchJSON("https://fapi.binance.com/fapi/v1/ticker/24hr");
    if (!res) { log("ÁÑ°Ê≥ïÂèñÂæóÂ∏ÇÂ†¥Ê∏ÖÂñÆ", "error"); return; }

    const newUniverse = res
        .filter(t => t.symbol.endsWith("USDT") && !IGNORED.includes(t.symbol) && parseFloat(t.quoteVolume) > CONFIG.MIN_VOL)
        .map(t => t.symbol);

    newUniverse.forEach(s => {
        if (!symState[s]) symState[s] = { trades: [], klines: [], price: 0, volZ: 0, deltaZ: 0 };
    });

    universe = newUniverse;
    $("univCount").innerText = universe.length;
    initCombinedStream(universe);
}

function buildTrackedTopN() {
    try {
        const all = universe.map(s => ({ s, ...symState[s] }));
        const active = all.filter(x => x.volZ > 0.1); 
        active.sort((a,b) => b.volZ - a.volZ);
        candidatesTopN = active.slice(0, 12);
        
        const c = $("card-container");
        if(candidatesTopN.length === 0) {
            c.innerHTML = `<div class="text-gray-600 col-span-full text-center py-10">Á≠âÂæÖÊï∏ÊìöÁ¥ØÁ©ç‰∏≠... (Ë´ãÁ¢∫Ë™çÂ∑¶‰∏äËßí Socket ÁãÄÊÖã)</div>`;
            return;
        }

        c.innerHTML = candidatesTopN.map((item, idx) => {
            const isTop = idx === 0;
            const colorZ = item.volZ > 3 ? "text-green-400 font-bold" : "text-gray-300";
            return `
            <div class="card p-3 ${isTop ? 'card-top1' : ''}">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-white">${item.s}</span>
                    <span class="text-xs font-mono text-gray-400">$${item.price}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><div class="muted">Vol Z</div><div class="${colorZ}">${item.volZ.toFixed(2)}</div></div>
                    <div><div class="muted">Delta Z</div><div class="text-white">${item.deltaZ.toFixed(2)}</div></div>
                </div>
                ${isTop ? `<div class="absolute top-0 right-0 px-2 py-0.5 bg-green-900 text-green-300 text-[10px] rounded-bl">AI TOP 1</div>` : ''}
            </div>`;
        }).join('');
    } catch(e) { console.error(e); }
}

async function askAI(force = false) {
    const currentKey = $("groqKeyInput").value || GROQ_KEY;
    
    // VALIDATION CHECKS
    if (force) {
        if (!currentKey) { showError("Áº∫Â∞ë API Key"); return; }
        if (candidatesTopN.length === 0) { showError("ÁõÆÂâçÊ≤íÊúâÊï∏ÊìöÂèØÂàÜÊûê"); return; }
    } else {
        if (!AUTO_AI || !currentKey || candidatesTopN.length === 0) return;
    }
    
    const targetSym = candidatesTopN[0].s; 
    setStatus("aiStatus", `ÂàÜÊûê ${targetSym}...`, "violet");
    
    await ensureKlinesAndOI(targetSym);
    const s = symState[targetSym];
    
    // DATA PACKAGING
    const payload = {
        symbol: targetSym,
        price: s.price,
        volZ: s.volZ,
        deltaZ: s.deltaZ,
        last_closes: s.klines ? s.klines.slice(-5).map(k=>parseFloat(k[4])) : []
    };
    
    const prompt = `
    Analyze Crypto: ${targetSym}. Data: ${JSON.stringify(payload)}.
    Mode: SCALPING.
    Output JSON ONLY: { "action": "BUY" or "WAIT", "reason": "brief reason < 15 words" }
    `;

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${currentKey}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: AI_MODEL,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.1 
            })
        });

        if (!res.ok) {
            const txt = await res.text(); // Read text first to avoid JSON crash
            log(`API Error (${res.status}): ${txt.substring(0,50)}`, "error");
            setStatus("aiStatus", "API Error", "bad");
            showError(`API Error ${res.status} - Ë´ãÊ™¢Êü• Key ÊàñÈ°çÂ∫¶`);
            return;
        }

        const json = await res.json();
        const content = json.choices[0].message.content;
        const cleanContent = content.replace(/<think>[\s\S]*?<\/think>/g, "").trim(); // Remove DeepSeek thoughts
        
        log(`[AI] ${targetSym}: ${cleanContent}`, "success");
        setStatus("aiStatus", "OK", "ok");

        // UI UPDATE
        const card = $("card-container").firstElementChild;
        if(card) {
             const div = document.createElement("div");
             div.className = "mt-2 p-2 bg-gray-900 rounded text-xs text-green-300 border border-green-900/50";
             div.textContent = `ü§ñ ${cleanContent.substring(0, 100)}`;
             const old = card.querySelectorAll(".bg-gray-900"); old.forEach(o => o.remove());
             card.appendChild(div);
        }

    } catch(e) {
        log(`System Error: ${e.message}`, "error");
        setStatus("aiStatus", "Sys Error", "bad");
    }
}

// INIT
window.onload = async () => {
    try {
        $("groqKeyInput").value = GROQ_KEY;
        $("modelSelect").value = AI_MODEL;

        $("btnSaveKey").onclick = () => { 
            GROQ_KEY = $("groqKeyInput").value.trim(); 
            localStorage.setItem("TRIDENT_GROQ_KEY", GROQ_KEY); 
            alert("API Key Â∑≤ÂÑ≤Â≠òÔºÅ"); 
        };
        
        $("btnToggleAI").onclick = () => { 
            AUTO_AI = !AUTO_AI; 
            $("autoLbl").innerText = `Auto: ${AUTO_AI?"ON":"OFF"}`; 
            $("btnToggleAI").className = `btn h-[38px] ${AUTO_AI?"btn-green":"border-gray-600"}`; 
        };
        
        $("btnRunAI").onclick = () => { askAI(true); };
        
        $("modelSelect").onchange = (e) => { AI_MODEL = e.target.value; };

        await refreshUniverse();
        
        setInterval(buildTrackedTopN, CONFIG.CANDIDATE_REFRESH_MS);
        setInterval(refreshUniverse, CONFIG.UNIVERSE_REFRESH_MS);
        setInterval(() => askAI(false), 30000); 
    } catch(e) {
        alert("Critical Init Error: " + e.message);
    }
};
</script>
</body>
</html>
