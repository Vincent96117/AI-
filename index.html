<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIDENT V7.6 - DEBUG EDITION</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
    body { background:#050505; color:#d4d4d8; font-family:'JetBrains Mono', monospace; overflow-x:hidden; }
    .panel { background:#0f0f11; border:1px solid #1f1f23; }
    .muted { color:#71717a; }
    .badge { border:1px solid #27272a; background:#0b0b0d; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
    .ok { color:#22c55e; } .warn { color:#f59e0b; } .bad { color:#ef4444; } .violet { color:#a78bfa; }
    .card { background:#0f0f11; border:1px solid #1f1f23; border-radius:14px; overflow:hidden; position:relative; }
    .card-top1 { border:2px solid #22c55e !important; box-shadow:0 0 15px rgba(34,197,94,0.15); }
    .btn { border:1px solid #27272a; background:#0b0b0d; border-radius:6px; padding:8px 16px; font-weight:700; font-size:13px; transition:0.2s; cursor:pointer; }
    .btn:hover { background:#27272a; color:white; }
    .btn-green { border-color:#16a34a; color:#86efac; background:rgba(22,163,74,0.2); }
    .btn-green:hover { background:rgba(22,163,74,0.4); box-shadow: 0 0 10px rgba(22,163,74,0.4); }
    .hb { width:8px; height:8px; background:#333; border-radius:50%; display:inline-block; margin-right:6px; }
    .hb-on { background:#22c55e; box-shadow:0 0 6px #22c55e; }
    select { background:#09090b; border:1px solid #27272a; color:#e4e4e7; padding:8px; border-radius:6px; font-size:12px; outline:none; cursor:pointer; }
    input { background:#09090b; border:1px solid #27272a; color:#e4e4e7; padding:8px; border-radius:6px; font-size:12px; outline:none; width: 200px; }
    /* Scrollbar */
    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:#000; }
    ::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
  </style>
</head>
<body class="p-4 text-sm">

<div class="panel p-4 rounded-xl mb-4 flex flex-col gap-4 shadow-lg">
  
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold tracking-tight text-white flex items-center">
      <span id="hb" class="hb"></span>TRIDENT <span class="text-green-500 text-sm ml-2">V7.6 (DEBUG)</span>
    </h1>
    <div class="flex gap-2">
      <span class="badge">Universe: <b id="univCount" class="text-white">0</b></span>
      <span class="badge">Socket: <b id="binStatus" class="muted">init...</b></span>
      <span class="badge">AI: <b id="aiStatus" class="muted">Idle</b></span>
    </div>
  </div>

  <div class="flex flex-wrap items-center gap-3 border-t border-gray-800 pt-3">
    
    <div class="flex flex-col gap-1">
        <label class="text-[10px] text-gray-500 font-bold">AI MODEL (æ¨¡å‹)</label>
        <select id="modelSelect" class="w-64">
            <option value="deepseek-r1-distill-llama-70b" selected>DeepSeek R1 (OpenAI-Level)</option>
            <option value="llama-3.3-70b-versatile">Llama 3.3 (Open GPT-4)</option>
            <option value="mixtral-8x7b-32768">Mixtral 8x7B (Stable)</option>
        </select>
    </div>
    
    <div class="flex flex-col gap-1">
        <label class="text-[10px] text-gray-500 font-bold">GROQ API KEY</label>
        <div class="flex gap-1">
            <input type="password" id="groqKeyInput" placeholder="gsk_xxxxxxxx..." />
            <button id="btnSaveKey" class="btn px-3 py-1 text-xs">å­˜æª”</button>
        </div>
    </div>

    <div class="flex items-end gap-2 ml-auto">
        <button id="btnRunAI" class="btn btn-green h-[38px] flex items-center gap-2">
           ğŸ§ª å¼·åˆ¶æ¸¬è©¦ AI (TEST)
        </button>
        <button id="btnToggleAI" class="btn border-gray-600 h-[38px]">
          <span id="autoLbl">Auto: OFF</span>
        </button>
    </div>
  </div>
</div>

<div id="errorBox" class="hidden mb-4 p-3 bg-red-900/20 border border-red-500/50 rounded-lg text-red-300 text-xs font-mono whitespace-pre-wrap"></div>

<div id="card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

<div class="mt-6 border-t border-gray-800 pt-2">
  <div class="flex justify-between items-center mb-1">
    <span class="text-xs font-bold text-gray-500">SYSTEM LOGS (è©³ç´°æ—¥èªŒ)</span>
    <button onclick="document.getElementById('logs').innerHTML=''" class="text-[10px] text-gray-600 hover:text-white">CLEAR</button>
  </div>
  <div id="logs" class="h-48 overflow-y-auto font-mono text-[11px] opacity-90 space-y-1 bg-[#0a0a0a] p-2 rounded border border-gray-800"></div>
</div>

<script>
/* =========================================================================
   TRIDENT V7.6 - DEBUG EDITION
   Focus: Explicit Error Handling for AI
   ========================================================================= */

// --- CONFIGURATION ---
const CONFIG = {
  MIN_VOL: 0, 
  UNIVERSE_REFRESH_MS: 10 * 60 * 1000, 
  CANDIDATE_REFRESH_MS: 1000, 
  ROLL_5M_MS: 5 * 60 * 1000,
  MAX_TRADES_STORE: 1000, 
  BTC_SYMBOL: "BTCUSDT"
};

const IGNORED = [
  "USDCUSDT","BUSDUSDT","TUSDUSDT","USDPUSDT","EURUSDT","FDUSDUSDT",
  "BTCUPUSDT","BTCDOWNUSDT","ETHUPUSDT","ETHDOWNUSDT","BNBUPUSDT","BNBDOWNUSDT",
  "BTCDOMUSDT", "1000LUNCUSDT", "USTCUSDT"
];

// --- STATE ---
let universe = [];
let symState = {}; 
let socketPool = [];
let candidatesTopN = [];
let GROQ_KEY = localStorage.getItem("TRIDENT_GROQ_KEY") || "";
let AUTO_AI = false;
let AI_MODEL = "deepseek-r1-distill-llama-70b"; 

// --- UTILS ---
const $ = (id) => document.getElementById(id);
const log = (msg, type="info") => {
    const l = $("logs");
    if(!l) return;
    const div = document.createElement("div");
    let color = "text-gray-400";
    if(type==="error") color = "text-red-400 font-bold";
    if(type==="success") color = "text-green-400";
    if(type==="warn") color = "text-yellow-400";
    
    div.innerHTML = `<span class="text-gray-600 mr-2">[${new Date().toLocaleTimeString()}]</span><span class="${color}">${msg}</span>`;
    l.prepend(div);
};
const setStatus = (id, txt, cls) => {
  const el = $(id); if(el) { el.textContent = txt; el.className = cls; }
};
const showError = (msg) => {
    const box = $("errorBox");
    box.textContent = "âš ï¸ " + msg;
    box.classList.remove("hidden");
    setTimeout(() => box.classList.add("hidden"), 10000); // 10ç§’å¾Œæ¶ˆå¤±
};

async function fetchJSON(url) {
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.status);
    return await res.json();
  } catch(e) { return null; }
}

// =========================================================================
// 1. DATA INGESTION
// =========================================================================
function initCombinedStream(symbols) {
  socketPool.forEach(s => s.close());
  socketPool = [];
  
  setStatus("binStatus", "é‡å»ºé€£ç·š...", "warn");
  
  const chunkSize = 50;
  for (let i = 0; i < symbols.length; i += chunkSize) {
    const chunk = symbols.slice(i, i + chunkSize);
    const streamName = chunk.map(s => `${s.toLowerCase()}@aggTrade`).join('/');
    const url = `wss://fstream.binance.com/stream?streams=${streamName}`;
    
    const ws = new WebSocket(url);
    ws.onopen = () => { if(i===0) setStatus("binStatus", "ç›£æ§ä¸­ (Live)", "ok"); };
    ws.onmessage = (ev) => {
        const packet = JSON.parse(ev.data);
        if (packet.data) processAggTrade(packet.data);
    };
    ws.onerror = () => setStatus("binStatus", "é€£ç·šéŒ¯èª¤", "bad");
    socketPool.push(ws);
  }
  $("hb").classList.add("hb-on");
}

function processAggTrade(d) {
    const sym = d.s;
    if (!symState[sym]) return;
    const s = symState[sym];
    const ts = d.T;
    const price = parseFloat(d.p);
    const qty = parseFloat(d.q);
    const notional = price * qty;
    const isBuy = !d.m; 
    
    s.price = price;
    s.trades.push({ ts, notional, deltaNotional: isBuy ? notional : -notional });

    if (s.trades.length % 50 === 0) {
        const cutoff = Date.now() - CONFIG.ROLL_5M_MS;
        while(s.trades.length > 0 && s.trades[0].ts < cutoff) s.trades.shift();
        if(s.trades.length > CONFIG.MAX_TRADES_STORE) s.trades.splice(0, s.trades.length - CONFIG.MAX_TRADES_STORE);
    }
    
    const stats = calcStats(s.trades, ts);
    s.volZ = stats.volZ;
    s.deltaZ = stats.deltaZ;
}

// =========================================================================
// 2. FEATURE ENGINEERING
// =========================================================================
function calcStats(trades, now) {
  if (trades.length < 10) return { volZ:0, deltaZ:0 };
  const cutoff = now - CONFIG.ROLL_5M_MS;
  let sum=0, sqSum=0, dSum=0, dSqSum=0, n=0;
  for (let i = trades.length - 1; i >= 0; i--) {
    const t = trades[i];
    if (t.ts < cutoff) break;
    sum += t.notional; sqSum += t.notional**2;
    dSum += t.deltaNotional; dSqSum += t.deltaNotional**2;
    n++;
  }
  if (n < 5) return { volZ:0, deltaZ:0 };
  
  const mean = sum/n;
  const std = Math.sqrt((sqSum/n) - mean*mean);
  const dMean = dSum/n;
  const dStd = Math.sqrt((dSqSum/n) - dMean*dMean);
  const last = trades[trades.length-1];
  
  return {
      volZ: std > 0 ? (last.notional - mean)/std : 0,
      deltaZ: dStd > 0 ? (last.deltaNotional - dMean)/dStd : 0
  };
}

function computeTechnicalFeatures(kLines, currentPrice) {
    if (!kLines || kLines.length < 20) return {};
    const closes = kLines.map(k => parseFloat(k[4]));
    const highs = kLines.map(k => parseFloat(k[2]));
    const lows = kLines.map(k => parseFloat(k[3]));
    
    const sma20 = closes.slice(-20).reduce((a,b)=>a+b,0) / 20;
    const swing_high_20 = Math.max(...highs.slice(-20));
    const swing_low_20 = Math.min(...lows.slice(-20));
    
    let trSum = 0;
    for(let i=1; i<15; i++) {
        const idx = kLines.length - i;
        const h = highs[idx], l = lows[idx], c_prev = closes[idx-1];
        trSum += Math.max(h-l, Math.abs(h-c_prev), Math.abs(l-c_prev));
    }
    const atr14 = trSum / 14;
    
    return {
        sma20, atr14, swing_high_20, swing_low_20,
        dist_sma20_atr: atr14 > 0 ? (currentPrice - sma20)/atr14 : 0,
        range_20_pct: (swing_high_20 - swing_low_20) / swing_low_20
    };
}

function computeVP(trades) {
    if (!trades.length) return {};
    const buckets = {};
    let totalVol = 0;
    trades.forEach(t => {
        const p = Math.floor(t.notional / (t.notional/t.price || 1));
        buckets[p] = (buckets[p] || 0) + t.notional;
        totalVol += t.notional;
    });
    
    let poc = 0, maxVol = 0;
    const sortedPrices = Object.keys(buckets).sort((a,b)=>parseFloat(a)-parseFloat(b));
    sortedPrices.forEach(p => {
        if(buckets[p] > maxVol) { maxVol = buckets[p]; poc = parseFloat(p); }
    });
    
    const top_nodes = Object.entries(buckets)
        .sort(([,a], [,b]) => b-a)
        .slice(0, 3)
        .map(([p, v]) => ({ price: parseFloat(p), pct: v/totalVol }));

    return { poc, top_nodes, totalVol };
}

async function ensureKlinesAndOI(sym) {
    const s = symState[sym];
    try {
        const kRes = await fetchJSON(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=5m&limit=30`);
        if(kRes) s.klines = kRes;
        
        const pRes = await fetchJSON(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`);
        if(pRes) s.funding = parseFloat(pRes.lastFundingRate);
    } catch(e) {}
}

function buildSummary(s, sym) {
    const techs = computeTechnicalFeatures(s.klines, s.price) || {};
    const vp = computeVP(s.trades) || {};
    
    return {
        symbol: sym,
        price: s.price,
        ret5m_pct: s.klines && s.klines.length ? (s.price - parseFloat(s.klines[s.klines.length-1][1])) / parseFloat(s.klines[s.klines.length-1][1]) : 0,
        vol5m_notional: vp.totalVol || 0,
        volZ_5m: s.volZ,
        active_buy_delta_5m_notional: s.deltaZ * 1000, 
        buy_ratio_5m: s.deltaZ > 0 ? 0.6 : 0.4,
        funding_pct: s.funding || 0,
        premium_pct: 0,
        oi_delta_5m: 0,
        oi_delta_4h: 0,
        atr14: techs.atr14 || 0,
        swing_low_20: techs.swing_low_20 || 0,
        swing_high_20: techs.swing_high_20 || 0,
        range_20_pct: techs.range_20_pct || 0,
        sma20: techs.sma20 || 0,
        dist_sma20_atr: techs.dist_sma20_atr || 0,
        today_vp: {
            poc: vp.poc || 0,
            price_vs_poc_pct: vp.poc ? (s.price - vp.poc)/vp.poc : 0,
            top_nodes: vp.top_nodes || []
        },
        stage: "SCALP_5M",
        preScore: s.volZ,
        tags: ["high_vol"],
        kline_interval: "5m",
        warmup_minutes: 5,
        mode: "LONG_ONLY",
        note: "DeepSeek Reasoning Mode"
    };
}

// =========================================================================
// 3. MAIN LOGIC (AI CORE FIX)
// =========================================================================

async function refreshUniverse() {
    log("æ­£åœ¨åˆ·æ–°å¸‚å ´æ¸…å–®...", "warn");
    const res = await fetchJSON("https://fapi.binance.com/fapi/v1/ticker/24hr");
    if (!res) return;

    const newUniverse = res
        .filter(t => t.symbol.endsWith("USDT") && !IGNORED.includes(t.symbol) && parseFloat(t.quoteVolume) > CONFIG.MIN_VOL)
        .map(t => t.symbol);

    newUniverse.forEach(s => {
        if (!symState[s]) symState[s] = { trades: [], klines: [], price: 0, volZ: 0, deltaZ: 0 };
    });

    universe = newUniverse;
    $("univCount").innerText = universe.length;
    initCombinedStream(universe);
}

function buildTrackedTopN() {
    const all = universe.map(s => ({ s, ...symState[s] }));
    const active = all.filter(x => x.volZ > 0.1); 
    active.sort((a,b) => b.volZ - a.volZ);
    candidatesTopN = active.slice(0, 12);
    
    const c = $("card-container");
    if(candidatesTopN.length === 0) {
        c.innerHTML = `<div class="text-gray-600 col-span-full text-center py-10">ç­‰å¾…æ•¸æ“šä¸­... è«‹ç¢ºèªå·¦ä¸Šè§’ Socket ç‹€æ…‹</div>`;
        return;
    }

    c.innerHTML = candidatesTopN.map((item, idx) => {
        const isTop = idx === 0;
        const colorZ = item.volZ > 3 ? "text-green-400 font-bold" : "text-gray-300";
        const colorD = item.deltaZ > 0 ? "text-green-400" : "text-red-400";
        return `
        <div class="card p-3 ${isTop ? 'card-top1' : ''}">
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-white">${item.s}</span>
                <span class="text-xs font-mono text-gray-400">$${item.price}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div><div class="muted">Vol Z</div><div class="${colorZ}">${item.volZ.toFixed(2)}</div></div>
                <div><div class="muted">Delta Z</div><div class="${colorD}">${item.deltaZ.toFixed(2)}</div></div>
            </div>
            ${isTop ? `<div class="absolute top-0 right-0 px-2 py-0.5 bg-green-900 text-green-300 text-[10px] rounded-bl">AI TOP 1</div>` : ''}
        </div>`;
    }).join('');
}

async function askAI(force = false) {
    const currentKey = $("groqKeyInput").value || GROQ_KEY;

    if (force) {
        log("å•Ÿå‹•å¼·åˆ¶æ¸¬è©¦...", "warn");
        if (!currentKey) {
             showError("æ²’æœ‰ API Keyï¼è«‹å…ˆè¼¸å…¥ Groq Key ä¸¦æŒ‰å­˜æª”");
             log("éŒ¯èª¤: ç¼ºå°‘ API Key", "error");
             return;
        }
        if (!currentKey.startsWith("gsk_")) {
             showError("API Key æ ¼å¼éŒ¯èª¤ï¼æ‡‰è©²æ˜¯ gsk_ é–‹é ­çš„");
             log("éŒ¯èª¤: Key æ ¼å¼ä¸å°", "error");
             return;
        }
        if (candidatesTopN.length === 0) {
             showError("ç›®å‰æ²’æœ‰å¸‚å ´æ•¸æ“šï¼Œè«‹ç­‰å¾…å¹¾ç§’é˜è®“æ•¸æ“šé€²ä¾†å†æŒ‰");
             log("éŒ¯èª¤: ç„¡å¸‚å ´æ•¸æ“š", "error");
             return;
        }
    } else {
        if (!AUTO_AI || !currentKey || candidatesTopN.length === 0) return;
    }
    
    const targetSym = candidatesTopN[0].s; 
    setStatus("aiStatus", `åˆ†æ ${targetSym}...`, "violet");
    log(`[AI] é–‹å§‹è«‹æ±‚ ${targetSym} ä½¿ç”¨æ¨¡å‹: ${AI_MODEL}`);
    
    await ensureKlinesAndOI(targetSym);
    const payload = buildSummary(symState[targetSym], targetSym);
    
    const prompt = `
    You are a professional Crypto Scalper using DeepSeek R1 logic.
    Mode: LONG_ONLY.
    Data: ${JSON.stringify(payload)}
    
    Think step-by-step:
    1. Check Vol Z score (>2 is good).
    2. Check Delta Z (must be positive for Long).
    3. Check SMA20 distance (mean reversion).
    4. Check VP POC (is price above POC?).
    
    Return JSON only:
    { "signal": "BUY" or "WAIT", "reason": "Short explanation", "confidence": 0-100 }
    `;

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${currentKey}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: AI_MODEL,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.1 
            })
        });

        if (!res.ok) {
            const errData = await res.json();
            const errMsg = errData.error ? errData.error.message : res.statusText;
            
            // ç¿»è­¯éŒ¯èª¤è¨Šæ¯
            let niceError = errMsg;
            if(res.status === 401) niceError = "API Key éŒ¯èª¤ (401) - è«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢º";
            if(res.status === 429) niceError = "è«‹æ±‚æ¬¡æ•¸éå¤š (429) - å…è²»é¡åº¦æ»¿äº†ï¼Œè«‹ç¨å¾Œå†è©¦";
            if(res.status === 503) niceError = "Groq æœå‹™ç¹å¿™ (503) - æ¨¡å‹æ­£åœ¨ç¶­ä¿®ä¸­";

            showError(niceError);
            log(`[AI] API å¤±æ•—: ${errMsg}`, "error");
            setStatus("aiStatus", "API Error", "bad");
            return;
        }

        const json = await res.json();
        const content = json.choices[0].message.content;
        
        // æ¸…æ´— <think> æ¨™ç±¤ (DeepSeek ç‰¹æœ‰)
        const cleanContent = content.replace(/<think>[\s\S]*?<\/think>/g, "").trim();
        
        log(`[AI] æˆåŠŸå›æ‡‰ (${targetSym})`, "success");
        
        // é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Š
        const card = $("card-container").firstElementChild;
        if(card) {
             const div = document.createElement("div");
             div.className = "mt-2 p-2 bg-gray-900 rounded text-xs text-green-300 border border-green-900/50";
             div.textContent = `ğŸ¤– ${cleanContent.substring(0, 120)}...`;
             // æ¸…é™¤èˆŠçš„ AI è¨Šæ¯
             const old = card.querySelectorAll(".bg-gray-900");
             old.forEach(o => o.remove());
             card.appendChild(div);
        }

        setStatus("aiStatus", "åˆ†æå®Œæˆ", "ok");
    } catch(e) {
        log(`[AI] ç¶²çµ¡/ç³»çµ±éŒ¯èª¤: ${e.message}`, "error");
        setStatus("aiStatus", "Sys Error", "bad");
    }
}

// --- INIT & EVENT LISTENERS ---
window.onload = async () => {
    $("groqKeyInput").value = GROQ_KEY;
    $("modelSelect").value = AI_MODEL;

    $("btnSaveKey").onclick = () => { 
        GROQ_KEY = $("groqKeyInput").value.trim(); 
        localStorage.setItem("TRIDENT_GROQ_KEY", GROQ_KEY); 
        alert("API Key å·²å„²å­˜ï¼"); 
    };
    
    $("btnToggleAI").onclick = () => { 
        AUTO_AI = !AUTO_AI; 
        $("autoLbl").innerText = `Auto: ${AUTO_AI?"ON":"OFF"}`; 
        $("btnToggleAI").className = `btn h-[38px] ${AUTO_AI?"btn-green":"border-gray-600"}`; 
    };
    
    $("btnRunAI").onclick = () => { askAI(true); };
    
    $("modelSelect").onchange = (e) => { 
        AI_MODEL = e.target.value; 
        log(`æ¨¡å‹åˆ‡æ›ç‚º: ${AI_MODEL}`, "warn"); 
    };

    await refreshUniverse();
    
    setInterval(buildTrackedTopN, CONFIG.CANDIDATE_REFRESH_MS);
    setInterval(refreshUniverse, CONFIG.UNIVERSE_REFRESH_MS);
    setInterval(() => askAI(false), 30000); 
};
</script>
</body>
</html>
